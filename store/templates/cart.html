{% extends "root.html" %}
{% load static %}

{% block title %}Shopping Cart - SafeCart{% endblock %}

{% block body_class %}bg-light{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="bg-primary text-white py-4 border-bottom">
  <div class="container text-center">
    <h1 class="fw-bold mb-1">Shopping Cart</h1>
    <p class="mb-0">Review your selected items</p>
  </div>
</section>

<!-- Cart + Summary Layout -->
<section>
  <div class="container py-4">
    <div class="row g-4 align-items-stretch">

      <!-- Left: Cart Items -->
      <div class="col-md-8 d-flex">
        <div class="border rounded p-3 bg-white w-100 d-flex flex-column overflow-auto" 
     id="cart-items-container" 
     style="max-height: 130vh;">


          {% if cart_items %}
          {% for item in cart_items %}
          <div class="d-flex align-items-center justify-content-between border-bottom py-3 cart-item"
            id="cart-item-{{ item.product.id }}">

            <!-- Product Image -->
            <div class="flex-shrink-0 me-3">
              <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}"
                style="width: 80px; height: 80px; object-fit: cover;" class="rounded">
            </div>

            <!-- Product Info -->
            <div class="flex-grow-1">
              <h6 class="mb-1">{{ item.product.name }}</h6>
              <p class="mb-0 text-primary fw-bold">‚Çπ{{ item.product.price }}</p>
              <!-- ‚úÖ Quantity controls -->
<div class="d-flex align-items-center">

  <!-- Decrease button -->
  <button 
    hx-post="{% url 'change_quantity' item.product.id %}" 
    hx-vals='{"action": "decrease"}'
    hx-swap="none"
    hx-on::after-request="updateCartState(event)" 
    class="btn btn-outline-secondary btn-sm"
    id="decrease-{{ item.product.id }}" 
    data-product-id="{{ item.product.id }}" 
    {% if item.quantity <= 1 %}disabled{% endif %}
  >‚àí</button>

  <!-- Current quantity -->
  <span id="qty-{{ item.product.id }}" class="mx-2 fw-bold">{{ item.quantity }}</span>

  <!-- Increase button -->
  <button 
    hx-post="{% url 'change_quantity' item.product.id %}" 
    hx-vals='{"action": "increase"}'
    hx-swap="none"
    hx-on::after-request="updateCartState(event)" 
    class="btn btn-outline-secondary btn-sm"
    id="increase-{{ item.product.id }}" 
    data-product-id="{{ item.product.id }}"
  >+</button>

</div>


            </div>

            <!-- Actions -->
            <div class="d-flex flex-column gap-2 ms-3">
              <!-- Remove -->
              <form hx-post="{% url 'remove_from_cart' item.product.id %}" hx-swap="none"
                hx-on::after-request="updateCartState(event)" method="post" class="m-0">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger btn-sm">
                  <i class="bi bi-trash"></i> Remove
                </button>
              </form>

              <!-- Wishlist -->
              <form hx-post="{% url 'move_to_wishlist' item.product.id %}" hx-swap="none"
                hx-on::after-request="updateWishlistState(event)" method="post" class="m-0">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-heart"></i> Wishlist
                </button>
              </form>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div class="text-center py-5">
            <h2>Your cart is empty</h2>
            <p class="text-muted">Looks like you haven‚Äôt added anything to your cart yet.</p>
            <a href="home" class="btn btn-primary">Continue Shopping</a>
          </div>
          {% endif %}

        </div>
      </div>


      <!-- Right: Order Summary + Address -->
      <div class="col-md-4 d-flex flex-column">
        <div class="card shadow-sm flex-grow-1 d-flex flex-column mb-3">
          <div class="card-body">
            <h5 class="fw-bold mb-3">Order Summary</h5>
            <div class="d-flex justify-content-between">
              <span>Subtotal</span>
              <span id="subtotal">‚Çπ{{ subtotal }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Tax (10%)</span>
              <span id="tax">‚Çπ{{ tax }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Shipping</span>
              <span id="shipping">‚Çπ{{ shipping }}</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-bold">
              <span>Total</span>
              <span id="total">‚Çπ{{ total }}</span>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mt-3 flex-grow-1 d-flex flex-column">
          <div class="card-body d-flex flex-column">
            <h5 class="fw-bold mb-3">Shipping Address</h5>

            <!-- Address Form -->
            {% if all_addresses|length > 1 %}
            <button type="button" class="btn btn-outline-primary w-100 mb-2" data-bs-toggle="modal"
              data-bs-target="#addressModal">
              Saved Addresses
            </button>
            {% endif %}

            <form method="post" action="{% url 'proceed_to_checkout' %}">
              {% csrf_token %}
              {{ form.as_p }}
              <button type="button" class="btn btn-outline-primary w-100 mb-2" id="use-current-location">
              üìç Use Current Location
              </button>
              <button type="submit" class="btn btn-success w-100 mb-2">Proceed to Checkout</button>
            </form>
          </div>
        </div>

        <!-- Address Modal -->
        <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addressModalLabel">Select Shipping Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- List of addresses -->
                <div class="list-group">
                  {% for addr in all_addresses %}
                  <label class="list-group-item d-flex justify-content-between align-items-start">
                    <div>
                      <strong>{{ addr.street }}</strong><br>
                      {{ addr.city }}, {{ addr.state }} - {{ addr.pincode }}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-success"
                      onclick="selectAddress('{{ addr.id }}', '{{ addr.street }}', '{{ addr.city }}', '{{ addr.state }}', '{{ addr.pincode }}')"
                      data-bs-dismiss="modal">
                      Use this
                    </button>
                  </label>
                  {% endfor %}

                <div class="modal fade" id="mapModal" tabindex="-1">
                  <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">

                      <div class="modal-header">
                        <h5 class="modal-title">Confirm Delivery Location</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div id="map" style="height:400px;"></div>
                        <form method="post" action="{% url 'confirm_address' %}">
                            {% csrf_token %}
                            <input type="hidden" name="latitude" id="latitude">
                            <input type="hidden" name="longitude" id="longitude">
                            <input type="hidden" name="address" id="address">

                            <button type="submit" class="btn btn-success">
                              Confirm Address
                            </button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>

                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.3"></script>

<script>
  function selectAddress(id, street, city, state, pincode) {
    document.querySelector('[name="street"]').value = street;
    document.querySelector('[name="city"]').value = city;
    document.querySelector('[name="state"]').value = state;
    document.querySelector('[name="pincode"]').value = pincode;
  }
</script>


<script>
  // Auto-dismiss flash messages
  function autoDismissFlash() {
    setTimeout(() => {
      document.querySelectorAll(".alert").forEach((alertElem) => {
        let bsAlert = bootstrap.Alert.getOrCreateInstance(alertElem);
        bsAlert.close();
      });
    }, 3000);
  }
  document.addEventListener("DOMContentLoaded", autoDismissFlash);

  function refreshFlashMessages() { autoDismissFlash(); }

  function updateCartState(event) {
    const xhr = event.detail.xhr;
    try {
      const data = JSON.parse(xhr.responseText);

      // update cart count in navbar
      if (data.cart_count !== undefined) {
        const cartCountElem = document.getElementById("cart-count");
        if (cartCountElem) cartCountElem.innerText = data.cart_count;
      }

      // replace flash messages
      if (data.flash_html !== undefined) {
        const flashContainer = document.getElementById("flash-messages");
        flashContainer.innerHTML = data.flash_html;
        refreshFlashMessages();
      }

      // if item removed, hide card
      if (data.removed_product_id !== undefined) {
        const card = document.getElementById("cart-item-" + data.removed_product_id);
        if (card) card.remove();
      }

      // ‚úÖ update order summary
      if (data.updated_product_id !== undefined && data.new_qty !== undefined) {
        const qtyElem = document.getElementById("qty-" + data.updated_product_id);
        if (qtyElem) qtyElem.innerText = data.new_qty;
      }

      // ‚úÖ Disable minus button if quantity <= 1
      if (data.updated_product_id !== undefined && data.new_qty !== undefined) {
        const decBtn = document.getElementById("decrease-" + data.updated_product_id);
        if (decBtn) {
          if (data.new_qty <= 1) {
            decBtn.disabled = true;
          } else {
            decBtn.disabled = false;
          }
        }
      }


      if (data.subtotal !== undefined) {
        document.getElementById("subtotal").innerText = "‚Çπ" + data.subtotal;
        document.getElementById("tax").innerText = "‚Çπ" + data.tax;
        document.getElementById("shipping").innerText = "‚Çπ" + data.shipping;
        document.getElementById("total").innerText = "‚Çπ" + data.total;
      }
      // if item removed, hide card
      if (data.removed_product_id !== undefined) {
        const card = document.getElementById("cart-item-" + data.removed_product_id);
        if (card) card.remove();
      }

      // if cart is empty, show the empty cart message
      if (data.cart_empty) {
        const container = document.getElementById("cart-items-container");
        container.innerHTML = `
      <div class="text-center py-5">
        <h2>Your cart is empty</h2>
        <p class="text-muted">Looks like you haven‚Äôt added anything to your cart yet.</p>
        <a href="home" class="btn btn-primary">Continue Shopping</a>
      </div>`;
      }

    } catch (e) {
      console.error("[updateCartState] JSON parse error:", e);
    }
  }

  function updateWishlistState(event) {
    const xhr = event.detail.xhr;
    try {
      const data = JSON.parse(xhr.responseText);

      if (data.wishlist_count !== undefined) {
        const wishlistCountElem = document.getElementById("wishlist-count");
        if (wishlistCountElem) wishlistCountElem.innerText = data.wishlist_count;
      }

      if (data.flash_html !== undefined) {
        const flashContainer = document.getElementById("flash-messages");
        flashContainer.innerHTML = data.flash_html;
        refreshFlashMessages();
      }

      // remove card when moved to wishlist
      if (data.moved_product_id !== undefined) {
        const card = document.getElementById("cart-item-" + data.moved_product_id);
        if (card) card.remove();
      }
      // ‚úÖ update order summary
      if (data.subtotal !== undefined) {
        document.getElementById("subtotal").innerText = "‚Çπ" + data.subtotal;
        document.getElementById("tax").innerText = "‚Çπ" + data.tax;
        document.getElementById("shipping").innerText = "‚Çπ" + data.shipping;
        document.getElementById("total").innerText = "‚Çπ" + data.total;
      }
      // if item removed, hide card
      if (data.removed_product_id !== undefined) {
        const card = document.getElementById("cart-item-" + data.removed_product_id);
        if (card) card.remove();
      }

      // if cart is empty, show the empty cart message
      if (data.cart_empty) {
        const container = document.getElementById("cart-items-container");
        container.innerHTML = `
      <div class="text-center py-5">
        <h2>Your cart is empty</h2>
        <p class="text-muted">Looks like you haven‚Äôt added anything to your cart yet.</p>
        <a href="home" class="btn btn-primary">Continue Shopping</a>
      </div>`;
      }

    } catch (e) {
      console.error("[updateWishlistState] JSON parse error:", e);
    }
  }
</script>

<script src="https://unpkg.com/htmx.org@1.9.3"></script>
<script>
  // Ensure Django CSRF token is added to all HTMX requests
  document.body.addEventListener('htmx:configRequest', (event) => {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
      event.detail.headers['X-CSRFToken'] = csrfToken.value;
    }
  });
</script>

<script>
document.getElementById("use-current-location").addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const latitude = pos.coords.latitude;
      const longitude = pos.coords.longitude;

      // redirect to backend with coords
      window.location.href =
        `/use-current-location/?latitude=${latitude}&longitude=${longitude}`;
    },
    () => alert("Location permission denied")
  );
});
</script>


{% endblock %}
