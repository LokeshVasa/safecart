<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Order Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
</head>

<body class="bg-light">

    <div class="container py-4">
        <h2 class="mb-4">Order Details (ID: {{ order.id }})</h2>

        <div class="card mb-4">
            <div class="card-body">
                <p><strong>User:</strong> {{ order.user.username }}</p>
                <p><strong>Address:</strong> {{ order.address.street }}, {{ order.address.city }}, {{
                    order.address.state }} - {{ order.address.pincode }}</p>
                <p><strong>Payment Type:</strong> {{ order.payment_type }}</p>
                <p><strong>Status:</strong> {{ order.status }}</p>

                <div class="mt-3">
                    <a href="{% url 'mark_order_delivered' order.id %}" class="btn btn-success me-2">Mark as
                        Delivered</a>
                    <a href="{% url 'delivery_dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="ratio ratio-16x9">
            <div id="map"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <script>
        // Initialize the map
        var map = L.map('map').fitWorld();

        // Free Carto Light tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            subdomains: 'abcd',
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        // Ramachandra College of Engineering coordinates, this is fixed destination. Change this try try with different addresses and use actual order address. 
        var destination = [16.6864208, 81.0256692];

        // Marker for destination
        L.circleMarker(destination, {
            radius: 8,
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.8
        }).addTo(map).bindPopup("Ramachandra College of Engineering").openPopup();

        // Get delivery agent location
        map.locate({ setView: true, maxZoom: 16, watch: true });

        var routingControl;

        function updateRoute(e) {
            var userLocation = e.latlng;

            if (routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(userLocation.lat, userLocation.lng),
                    L.latLng(destination[0], destination[1])
                ],
                createMarker: function () { return null; },
                lineOptions: { styles: [{ color: 'blue', weight: 5, opacity: 0.7 }] },
                addWaypoints: false,
                draggableWaypoints: false,
                routeWhileDragging: false,
                fitSelectedRoutes: true,
                show: false,
                collapsible: false
            }).addTo(map);
        }

        map.on('locationfound', updateRoute);
        map.on('locationerror', function () { alert("Cannot get your location."); });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>