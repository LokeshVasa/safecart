<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Order Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
</head>

<body class="bg-light">

<div class="container py-4">
    <h2 class="mb-4">Order Details (ID: {{ order.id }})</h2>

    <div class="card mb-4">
        <div class="card-body">
            <p><strong>User:</strong> {{ order.user.username }}</p>
            <p><strong>Address:</strong>
                {{ order.address.street }},
                {{ order.address.city }},
                {{ order.address.state }} -
                {{ order.address.pincode }}
            </p>
            <p><strong>Payment Type:</strong> {{ order.payment_type }}</p>
            <p><strong>Status:</strong> {{ order.status }}</p>

            <div class="mt-3">
                <a href="{% url 'mark_order_delivered' order.id %}" class="btn btn-success me-2">
                    Mark as Delivered
                </a>
                <a href="{% url 'delivery_dashboard' %}" class="btn btn-secondary">
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Map -->
    <div class="ratio ratio-16x9">
        <div id="map"></div>
    </div>
</div>

<!-- JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
    /* ===================== MAP INIT ===================== */
    var map = L.map('map').fitWorld();

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        maxZoom: 19
    }).addTo(map);

    /* ===================== DYNAMIC DESTINATION ===================== */
    var destinationLat = {{ 'order.address.latitude' }};
    var destinationLng = {{ 'order.address.longitude' }};
    var destination = [destinationLat, destinationLng];

    /* Order Location Marker */
    L.circleMarker(destination, {
        radius: 8,
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.9
    }).addTo(map)
      .bindPopup("Customer Delivery Location")
      .openPopup();

    /* ===================== AGENT LOCATION ===================== */
    map.locate({
        setView: true,
        maxZoom: 16,
        watch: true
    });

    var routingControl;

    function updateRoute(e) {
        var agentLat = e.latlng.lat;
        var agentLng = e.latlng.lng;

        if (routingControl) {
            map.removeControl(routingControl);
        }

        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(agentLat, agentLng),
                L.latLng(destinationLat, destinationLng)
            ],
            createMarker: function () { return null; },
            lineOptions: {
                styles: [{ weight: 5, opacity: 0.7 }]
            },
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            show: false
        }).addTo(map);
    }

    map.on('locationfound', updateRoute);

    map.on('locationerror', function () {
        alert("Location permission denied.");
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
