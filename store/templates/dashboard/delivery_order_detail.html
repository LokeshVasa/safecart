<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Order Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
</head>

<body class="bg-light">

    <div class="container py-4">
        <h2 class="mb-4">Order Details (ID: {{ order.id }})</h2>

        <div class="card mb-4">
            <div class="card-body">
                <p><strong>User:</strong> {{ order.user.username }}</p>
                <p><strong>Address:</strong> {{ order.address.street }}, {{ order.address.city }},
                    {{ order.address.state }} - {{ order.address.pincode }}</p>
                <p><strong>Payment Type:</strong> {{ order.payment_type }}</p>
                <p><strong>Status:</strong> {{ order.status }}</p>

                <div class="mt-3">
                    <a href="{% url 'mark_order_delivered' order.id %}" class="btn btn-success me-2">
                        Mark as Delivered
                    </a>
                    <a href="{% url 'delivery_dashboard' %}" class="btn btn-secondary">
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="card mb-4 border border-dark">
            <div class="card-body p-0">
                <div class="ratio ratio-16x9">
                    <div id="map"></div>
                </div>
            </div>
        </div>


        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

        <script>
            // SafeCart delivery agent icon
            var deliveryAgentIcon = L.icon({
                iconUrl: '/media/assets/delivery-agent.png',   // adjust path if needed
                iconSize: [72, 72],
                iconAnchor: [36, 50],
                popupAnchor: [0, -50]

            });

            // Destination pin icon
            var destinationIcon = L.icon({
                iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers/img/marker-icon-2x-blue.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            });

            // Initialize the map
            var map = L.map('map').fitWorld();

            // Beautiful OpenStreetMap tiles (like Leaflet demo)
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'SafeCart &copy',
                maxZoom: 19
            }).addTo(map);


            // Add scale control
            L.control.scale({ position: 'bottomleft' }).addTo(map);

            // Destination coordinates (Garuda Food Court) 
            var destination = [16.778893088489124, 81.22118994913994];

            // Destination marker using pin icon
            L.marker(destination, { icon: destinationIcon })
                .addTo(map)
                .bindPopup("Garuda Food Court")
                .openPopup();

            // Get delivery agent location
            map.locate({ setView: true, maxZoom: 16, watch: true });

            var routingControl;
            var deliveryMarker = null;

            function updateRoute(e) {
                var userLocation = e.latlng;

                // Delivery agent marker
                if (!deliveryMarker) {
                    deliveryMarker = L.marker(userLocation, { icon: deliveryAgentIcon })
                        .addTo(map)
                        .bindPopup("Delivery Agent");
                } else {
                    deliveryMarker.setLatLng(userLocation);
                }

                if (routingControl) {
                    map.removeControl(routingControl);
                }

                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(userLocation.lat, userLocation.lng),
                        L.latLng(destination[0], destination[1])
                    ],
                    createMarker: function () { return null; },
                    lineOptions: {
                        styles: [{
                            color: 'black',
                            weight: 6,
                            opacity: 0.9
                        }]
                    },
                    addWaypoints: false,
                    draggableWaypoints: false,
                    routeWhileDragging: false,
                    fitSelectedRoutes: true,
                    show: false,
                    collapsible: false
                }).addTo(map);
            }

            map.on('locationfound', updateRoute);
            map.on('locationerror', function () { alert("Cannot get your location."); });
        </script>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>