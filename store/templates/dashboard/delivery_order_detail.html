<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Order Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
</head>

<body class="bg-light">

<div class="container py-4">
    <h2 class="mb-4">Order Details (ID: {{ order.id }})</h2>

    <div class="card mb-4">
        <div class="card-body">
            <p><strong>User:</strong> {{ order.user.username }}</p>
            <p><strong>Address:</strong>
                {{ order.address.street }},
                {{ order.address.city }},
                {{ order.address.state }} -
                {{ order.address.pincode }}
            </p>
            <p><strong>Payment Type:</strong> {{ order.payment_type }}</p>
            <p><strong>Status:</strong> {{ order.status }}</p>

            <div class="mt-3">
                <a href="{% url 'mark_order_delivered' order.id %}" class="btn btn-success me-2">
                    Mark as Delivered
                </a>
                <a href="{% url 'delivery_dashboard' %}" class="btn btn-secondary">
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Map Card -->
    <div class="card mb-4 border border-dark">
        <div class="card-body p-0">
            <div class="ratio ratio-16x9">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
    // Delivery agent icon
    var deliveryAgentIcon = L.icon({
        iconUrl: '/static/images/delivery-agent.png',
        iconSize: [72, 72],
        iconAnchor: [36, 50],
        popupAnchor: [0, -50]
    });

    // Destination icon
    var destinationIcon = L.icon({
        iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers/img/marker-icon-2x-blue.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    });

    // Init map
    var map = L.map('map').fitWorld();

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'SafeCart Â©',
        maxZoom: 19
    }).addTo(map);

    L.control.scale({ position: 'bottomleft' }).addTo(map);

    // Destination from DB
    var destinationLat = {{ order.address.latitude|default:0 }};
    var destinationLng = {{ order.address.longitude|default:0 }};

    var routingControl;
    var deliveryMarker = null;

    if (destinationLat !== 0 && destinationLng !== 0) {
        L.marker([destinationLat, destinationLng], { icon: destinationIcon })
            .addTo(map)
            .bindPopup("Customer Delivery Location")
            .openPopup();
    }

    map.locate({ setView: true, maxZoom: 16, watch: true });

    function updateRoute(e) {
        if (destinationLat === 0 || destinationLng === 0) return;

        var agentLocation = e.latlng;

        if (!deliveryMarker) {
            deliveryMarker = L.marker(agentLocation, { icon: deliveryAgentIcon })
                .addTo(map)
                .bindPopup("Delivery Agent");
        } else {
            deliveryMarker.setLatLng(agentLocation);
        }

        if (routingControl) {
            map.removeControl(routingControl);
        }

        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(agentLocation.lat, agentLocation.lng),
                L.latLng(destinationLat, destinationLng)
            ],
            createMarker: function () { return null; },
            lineOptions: {
                styles: [{
                    color: 'black',
                    weight: 6,
                    opacity: 0.9
                }]
            },
            addWaypoints: false,
            draggableWaypoints: false,
            routeWhileDragging: false,
            fitSelectedRoutes: true,
            show: false,
            collapsible: false
        }).addTo(map);
    }

    map.on('locationfound', updateRoute);
    map.on('locationerror', function () {
        alert("Cannot get your location.");
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
